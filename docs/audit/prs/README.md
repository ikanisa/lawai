# Audit Remediation PRs

This directory contains PR-ready patches for critical and high-priority findings from the Full-Stack Repo Audit & Production Hardening assessment.

## Structure

Each PR is organized in its own subdirectory:

```
prs/
├── README.md (this file)
└── pr-[number]-[slug]/
    ├── CHANGELOG.md       # Conventional Commits changelog with testing & rollback
    ├── [name].patch       # Unified diff patch file
    └── verification.md    # Detailed verification steps (optional)
```

## Available PRs

### P0 (Critical - Block Go-Live)

#### PR #001: Implement CSP Headers
- **Severity**: P0 - Critical
- **Effort**: 4 hours
- **Impact**: Prevents XSS attacks
- **Files**: `apps/pwa/next.config.mjs`, `apps/web/next.config.mjs`
- **Status**: Ready to apply

**Apply**:
```bash
cd /home/runner/work/lawai/lawai
git apply docs/audit/prs/pr-001-csp-headers/csp-headers.patch
pnpm build
pnpm test
git add apps/pwa/next.config.mjs apps/web/next.config.mjs
git commit -F docs/audit/prs/pr-001-csp-headers/CHANGELOG.md
```

**Verify**:
```bash
pnpm --filter @apps/pwa build && pnpm --filter @apps/pwa start &
sleep 5
curl -I http://localhost:3000 | grep -i "content-security-policy"
kill %1
```

---

## Additional PRs (To Be Created)

The following PRs should be created based on the audit findings:

### P0 (Critical)

- **PR #002**: Prompt Injection Mitigations
  - Files: `apps/api/src/agent.ts`, `apps/api/src/agent-wrapper.ts`
  - Effort: 1 day
  
- **PR #003**: Service Worker for Public PWA
  - Files: `apps/pwa/next.config.mjs`, `apps/pwa/public/*`
  - Effort: 2 days
  
- **PR #004**: Service Worker for Admin PWA
  - Files: `apps/web/next.config.mjs`, `apps/web/public/*`
  - Effort: 1 day
  
- **PR #005**: Admin PWA Manifest
  - Files: `apps/web/public/manifest.json`
  - Effort: 2 hours
  
- **PR #006**: Secret Validation in CI
  - Files: `.github/workflows/monorepo-ci.yml`, `scripts/validate-secrets.mjs`
  - Effort: 2 hours
  
- **PR #007**: Legal Disclaimers
  - Files: `apps/api/src/agent.ts`
  - Effort: 1 hour

### P1 (High Priority)

- **PR #008**: Container Image Signing
  - Files: `.github/workflows/container-scan.yml`
  - Effort: 1 day
  
- **PR #009**: SLSA Provenance
  - Files: `.github/workflows/deploy.yml`
  - Effort: 1 day
  
- **PR #010**: PWA Icon Generation
  - Files: `apps/pwa/scripts/`, `apps/web/scripts/`
  - Effort: 4 hours

## Application Guidelines

1. **Review CHANGELOG.md** for each PR before applying
2. **Test locally** after applying patch
3. **Verify rollback plan** works
4. **Run CI checks** (lint, typecheck, test, build)
5. **Deploy to staging** first
6. **Monitor** for issues before production

## Rollback Procedure

If a patch causes issues:

```bash
# Revert the patch
git apply -R docs/audit/prs/pr-XXX-slug/name.patch

# Or use git checkout
git checkout HEAD -- <affected-files>

# Rebuild and test
pnpm build
pnpm test
```

## Dependencies

Some PRs have dependencies on others. Check the `dependencies` field in each CHANGELOG.md.

**Dependency Graph**:
```
PR #001 (CSP) → Independent
PR #002 (Prompt Injection) → Independent
PR #003 (PWA SW) → PR #010 (Icons)
PR #004 (Admin SW) → PR #003, PR #005, PR #010
PR #005 (Admin Manifest) → PR #010
PR #006 (Secret Validation) → Independent
PR #007 (Disclaimers) → Independent
PR #008 (Image Signing) → Independent
PR #009 (SLSA) → PR #008
PR #010 (Icons) → Independent
```

## Priority Order

**Immediate** (can apply now):
1. PR #001 (CSP Headers) - 4 hours
2. PR #006 (Secret Validation) - 2 hours
3. PR #007 (Legal Disclaimers) - 1 hour

**Next** (after icons generated):
4. PR #010 (Icon Generation) - 4 hours
5. PR #005 (Admin Manifest) - 2 hours

**Then** (parallel tracks):
- Security Track: PR #002, PR #008, PR #009
- PWA Track: PR #003, PR #004

## Testing Checklist

After applying patches:

- [ ] `pnpm install` (if dependencies changed)
- [ ] `pnpm typecheck` (TypeScript compilation)
- [ ] `pnpm lint` (code style)
- [ ] `pnpm test` (unit tests)
- [ ] `pnpm build` (production build)
- [ ] Local smoke test (start app, test critical flows)
- [ ] Review git diff (ensure only expected changes)
- [ ] Check for secrets or sensitive data
- [ ] Verify no binary files added accidentally

## Questions?

Refer to:
- Audit reports in `docs/audit/[number]-[name].md`
- Remediation roadmap in `docs/audit/80-roadmap.md`
- Machine-readable audit report in `docs/audit/audit-report.json`

---

**Generated by**: Full-Stack Repo Audit & Production Hardening (2025-11-01)
