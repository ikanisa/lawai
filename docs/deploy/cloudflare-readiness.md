# Cloudflare Production Deployment Readiness Audit

**Generated**: 2026-01-05  
**Auditor**: Senior Release Engineer  
**Scope**: Cloudflare Pages + Next.js SSR (via @cloudflare/next-on-pages)

---

## Executive Summary

The `lawai` monorepo is configured for Cloudflare Pages deployment using Next.js 14 with `@cloudflare/next-on-pages` for SSR support. The primary frontend app (`apps/web`) uses Next.js App Router with Server Components and API routes running on the edge runtime.

**Status**: üü° **MOSTLY READY** - Core infrastructure is in place, but production hardening items need attention.

---

## 1. Frontend Applications

### Primary: `apps/web` (Main Web App)

| Property | Value |
|----------|-------|
| **Framework** | Next.js 14.2.5 (App Router) |
| **Rendering** | Server Components + SSR (edge runtime) |
| **Build Output** | `apps/web/.vercel/output/static` (via @cloudflare/next-on-pages) |
| **Localization** | `[locale]` route segments (fr, en) |
| **PWA** | Service Worker with Workbox |
| **API Routes** | 17 endpoints in `/api/*` (all edge runtime) |

**Build Scripts** (from `apps/web/package.json`):
- ‚úÖ `build`: `next build && node ./scripts/inject-sw.mjs`
- ‚úÖ `pages:build`: `pnpm run build && pnpm exec next-on-pages`
- ‚úÖ `pages:preview`: `wrangler pages dev .vercel/output/static`
- ‚úÖ `deploy:cloudflare`: `pnpm run pages:build && wrangler pages deploy .vercel/output/static`
- ‚úÖ `lint`: ESLint check
- ‚úÖ `typecheck`: TypeScript check
- ‚úÖ `test`: Vitest tests

**Build Output Structure**:
```
apps/web/.vercel/output/static/
‚îú‚îÄ‚îÄ _worker.js          # Edge runtime bundle (generated by next-on-pages)
‚îú‚îÄ‚îÄ _routes.json        # Routing configuration
‚îú‚îÄ‚îÄ _headers            # Security headers (if present)
‚îú‚îÄ‚îÄ _redirects          # SPA routing (if present)
‚îî‚îÄ‚îÄ static assets...
```

### Secondary Apps (Not Deployed to Cloudflare Pages)

| App | Framework | Purpose | Deployment Target |
|-----|-----------|---------|-------------------|
| `apps/pwa` | Next.js 14 | Consumer PWA | Separate deployment (Netlify) |
| `apps/admin-pwa` | Next.js 14 | Admin dashboard | Separate deployment |
| `apps/staff-pwa` | Next.js 14 | Staff interface | Separate deployment |
| `apps/api` | Fastify | Backend API | Railway/Container |
| `apps/edge` | Deno | Edge functions | Supabase Edge Functions |
| `apps/mcp` | Node.js | MCP Server | Self-hosted |

---

## 2. Backend/Edge Code Analysis

### Server-Side Code in `apps/web`

| Component | Runtime Requirement | Cloudflare Compatibility |
|-----------|---------------------|-------------------------|
| `src/env.server.ts` | Server-only imports | ‚úÖ Compatible (server-only package works) |
| `src/server/supabase/admin-client.ts` | Supabase admin client | ‚úÖ Compatible |
| `app/api/*` (17 routes) | API Routes | ‚úÖ All use `export const runtime = 'edge'` |
| `app/[locale]/layout.tsx` | Server Component | ‚úÖ Uses `export const runtime = 'edge'` |

**API Routes Found**:
- `/api/admin/*` (15 endpoints): agents, audit-log, billing, corpus, evaluations, hitl, ingestion, jobs, jurisdictions, overview, people, policies, session, telemetry, workflows
- `/api/auth/session` (1 endpoint): Authentication session
- `/api/session` (1 endpoint): Client session resolution

### Runtime Assumptions

| Assumption | Status | Notes |
|------------|--------|-------|
| Node.js `fs` module | ‚úÖ Not used | No file system access in runtime code |
| Native modules | ‚ö†Ô∏è `sharp` in devDependencies | Only used in build scripts (icon generation), not runtime |
| `process.env` | ‚úÖ Supported | Via `nodejs_compat` flag in wrangler.toml |
| `server-only` import | ‚úÖ Compatible | Works with edge runtime |
| Edge runtime | ‚úÖ All routes use `runtime = 'edge'` | Required for Cloudflare Pages Functions |

> [!NOTE]
> `sharp` is listed as a devDependency and only used in `prebuild` scripts for icon generation. This is safe for Cloudflare deployment.

---

## 3. Environment Variables Matrix

### Client-Side Variables (NEXT_PUBLIC_*)

These are **exposed to the browser** and should be set in Cloudflare Pages Dashboard ‚Üí Settings ‚Üí Environment Variables.

| Variable | Dev | Preview | Prod | Required | Notes |
|----------|-----|---------|------|----------|-------|
| `NEXT_PUBLIC_API_BASE_URL` | `http://localhost:3333` | Preview API URL | Production API URL | ‚úÖ Yes | API endpoint |
| `NEXT_PUBLIC_SUPABASE_URL` | Local Supabase | Preview Supabase | Production Supabase | ‚úÖ Yes | Supabase project URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Local key | Preview key | Production key | ‚úÖ Yes | Supabase anonymous key |
| `NEXT_PUBLIC_APP_URL` | `http://localhost:3000` | Preview URL | Production URL | ‚ö†Ô∏è Optional | Used for redirects/OAuth |
| `NEXT_PUBLIC_DASHBOARD_RUNS_HIGH` | `1000` | `1000` | `1000` | ‚ö†Ô∏è Optional | Dashboard threshold |
| `NEXT_PUBLIC_DASHBOARD_RUNS_MEDIUM` | `200` | `200` | `200` | ‚ö†Ô∏è Optional | Dashboard threshold |
| `NEXT_PUBLIC_EVAL_PASS_GOOD` | `0.9` | `0.9` | `0.9` | ‚ö†Ô∏è Optional | Evaluation threshold |
| `NEXT_PUBLIC_EVAL_PASS_OK` | `0.75` | `0.75` | `0.75` | ‚ö†Ô∏è Optional | Evaluation threshold |
| `NEXT_PUBLIC_EVAL_COVERAGE_GOOD` | `0.9` | `0.9` | `0.9` | ‚ö†Ô∏è Optional | Evaluation threshold |
| `NEXT_PUBLIC_EVAL_COVERAGE_OK` | `0.75` | `0.75` | `0.75` | ‚ö†Ô∏è Optional | Evaluation threshold |
| `NEXT_PUBLIC_EVAL_MAGHREB_GOOD` | `0.95` | `0.95` | `0.95` | ‚ö†Ô∏è Optional | Evaluation threshold |
| `NEXT_PUBLIC_EVAL_MAGHREB_OK` | `0.8` | `0.8` | `0.8` | ‚ö†Ô∏è Optional | Evaluation threshold |
| `NEXT_PUBLIC_TOOL_FAILURE_WARN` | `0.02` | `0.02` | `0.02` | ‚ö†Ô∏è Optional | Tool failure threshold |
| `NEXT_PUBLIC_TOOL_FAILURE_CRIT` | `0.05` | `0.05` | `0.05` | ‚ö†Ô∏è Optional | Tool failure threshold |
| `NEXT_PUBLIC_ENABLE_PWA` | `false` | `false` | `true` | ‚ö†Ô∏è Optional | PWA feature flag |

### Server-Side Variables

These are used in Server Components and API routes. They are **NOT exposed to the browser**.

| Variable | Dev | Preview | Prod | Required | Location |
|----------|-----|---------|------|----------|----------|
| `NODE_ENV` | `development` | `production` | `production` | ‚úÖ Auto-set | Auto-set by platform |
| `APP_ENV` | `local` | `preview` | `production` | ‚ö†Ô∏è Optional | Pages env vars |
| `DEPLOY_ENV` | `development` | `preview` | `production` | ‚ö†Ô∏è Optional | Pages env vars |
| `SUPABASE_URL` | Local | Preview | Production | ‚úÖ Yes | Pages env vars (server-only) |
| `SUPABASE_SERVICE_ROLE_KEY` | Local key | Preview key | Production key | ‚úÖ Yes | Pages env vars (secret) |
| `ADMIN_PANEL_ACTOR` | - | - | Admin email | ‚ö†Ô∏è Optional | Pages env vars |
| `ADMIN_PANEL_ORG` | - | - | Admin org ID | ‚ö†Ô∏è Optional | Pages env vars |
| `FEAT_ADMIN_PANEL` | `enabled` | `enabled` | `enabled` | ‚ö†Ô∏è Optional | Pages env vars |

> [!WARNING]
> Server-side variables (`SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`) must be set in Cloudflare Pages Dashboard ‚Üí Settings ‚Üí Environment Variables. They are available to Server Components and API routes but NOT to client-side code.

### Cloudflare-Specific Configuration

| Setting | Value | Location |
|---------|-------|----------|
| `CLOUDFLARE_API_TOKEN` | (GitHub Secret) | GitHub Actions (if using CI deployment) |
| `CLOUDFLARE_ACCOUNT_ID` | (GitHub Secret) | GitHub Actions (if using CI deployment) |

---

## 4. Repo & Build Reproducibility

### Lockfile Status

| Item | Status | Notes |
|------|--------|-------|
| `pnpm-lock.yaml` | ‚úÖ Committed | Present in repo root |
| CI uses lockfile | ‚ö†Ô∏è Needs verification | Cloudflare Pages should use `pnpm install --frozen-lockfile` |

### Build Scripts

| Script | Status | Command |
|--------|--------|---------|
| `lint` | ‚úÖ Defined | `eslint --max-warnings=0 --ext .ts,.tsx app src` |
| `typecheck` | ‚úÖ Defined | `tsc --noEmit` |
| `test` | ‚úÖ Defined | `vitest run` |
| `build` | ‚úÖ Defined | `next build && node ./scripts/inject-sw.mjs` |
| `pages:build` | ‚úÖ Defined | `pnpm run build && pnpm exec next-on-pages` |
| `pages:preview` | ‚úÖ Defined | `wrangler pages dev .vercel/output/static` |

### Build Output Determinism

| Framework | Output Directory | Status |
|-----------|------------------|--------|
| Next.js (via next-on-pages) | `apps/web/.vercel/output/static` | ‚úÖ Correct |

### Version Pinning

| Item | Status | Value |
|------|--------|-------|
| Node version | ‚úÖ Pinned | `.nvmrc` exists (need to verify value) |
| Package manager | ‚úÖ Pinned | `packageManager: "pnpm@8.15.4"` in root package.json |
| CI Node version | ‚ö†Ô∏è Needs verification | Should match `.nvmrc` |

> [!NOTE]
> Verify `.nvmrc` contains Node 20 (required by Next.js 14 and Cloudflare Pages).

---

## 5. Cloudflare Pages Project Configuration

### Current Configuration (from `wrangler.toml`)

```toml
name = "avocat-ai-web"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]
pages_build_output_dir = "apps/web/.vercel/output/static"
```

### Required Dashboard Settings

| Setting | Value | Status |
|---------|-------|--------|
| **Framework preset** | `None` | ‚ö†Ô∏è Verify in dashboard |
| **Production branch** | `main` (or your default) | ‚ö†Ô∏è Set explicitly |
| **Build command** | `pnpm install && pnpm --filter @avocat-ai/web run pages:build` | ‚ö†Ô∏è Verify |
| **Build output directory** | `apps/web/.vercel/output/static` | ‚úÖ Correct |
| **Root directory** | `/` (monorepo root) | ‚úÖ Correct |
| **Node version** | `20` | ‚ö†Ô∏è Verify |

> [!IMPORTANT]
> Set the **production branch** explicitly in Cloudflare Pages Dashboard. Don't rely on defaults.

---

## 6. Routing (SPAs) and Edge Behavior

### Current Routing Setup

The app uses Next.js App Router with:
- Locale-based routing: `/[locale]/*` (fr, en)
- API routes: `/api/*`
- Server Components with edge runtime

### Required Files

| File | Status | Location | Purpose |
|------|--------|----------|---------|
| `_redirects` | ‚ùå **MISSING** | `apps/web/public/_redirects` | SPA fallback for deep links |
| `_routes.json` | ‚ö†Ô∏è Generated by next-on-pages | `apps/web/.vercel/output/static/` | Routing configuration |
| `404.html` | ‚ö†Ô∏è May be needed | `apps/web/public/404.html` | Custom 404 page (optional) |

> [!WARNING]
> **Missing `_redirects` file**: This is required for SPA routing. Without it, direct navigation to routes like `/fr/workspace` will return 404 on refresh.

**Required `_redirects` pattern**:
```
/*    /index.html   200
```

This ensures all non-file routes serve `index.html` while preserving static asset paths.

---

## 7. Headers & Security Controls

### Current Headers File

Location: `apps/web/public/_headers`

Current content:
```
/*
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  Referrer-Policy: strict-origin-when-cross-origin
  Permissions-Policy: geolocation=(), microphone=(), camera=()

/_next/static/*
  Cache-Control: public, max-age=31536000, immutable
```

### Missing Security Headers

| Header | Status | Notes |
|--------|--------|-------|
| `Content-Security-Policy` | ‚ùå **MISSING** | Critical for XSS protection |
| `X-Content-Type-Options` | ‚úÖ Present | `nosniff` |
| `X-Frame-Options` | ‚úÖ Present | `DENY` |
| `Referrer-Policy` | ‚úÖ Present | `strict-origin-when-cross-origin` |
| `Permissions-Policy` | ‚úÖ Present | Locked down |
| `Strict-Transport-Security` | ‚ùå **MISSING** | Only enable if all subdomains are HTTPS-ready |
| Cache headers for `index.html` | ‚ùå **MISSING** | Should be short cache or no-cache |

> [!IMPORTANT]
> **CSP is configured in `next.config.mjs`** but needs to be in `_headers` for Cloudflare Pages static assets. Headers set in Next.js config apply to Server Components/API routes, but static assets need `_headers`.

> [!WARNING]
> **Headers do NOT apply to Pages Functions**: The `_headers` file applies to static assets only. Headers for API routes (`/api/*`) must be set in the function code (Next.js response headers).

### Recommended Headers Enhancement

The `_headers` file should include:
1. CSP (Content-Security-Policy) - from next.config.mjs or simplified
2. Caching rules:
   - Hashed assets (`/_next/static/*`): Long cache (immutable) ‚úÖ Already present
   - `index.html`: Short cache or no-cache (to avoid stale deployments)
   - Service worker (`/sw.js`): No-cache or short cache

---

## 8. CORS, Auth, Sessions

### Current Implementation

| Aspect | Status | Notes |
|--------|--------|-------|
| Auth provider | ‚úÖ External (Supabase) | Auth handled by Supabase Auth |
| API CORS | ‚ö†Ô∏è Needs verification | Check if API routes set CORS headers |
| CSRF protection | ‚ö†Ô∏è Needs verification | Verify cookie security (SameSite) |
| Rate limiting | ‚ùå **NOT IMPLEMENTED** | Should be added for API routes |
| Session management | ‚úÖ Supabase sessions | Cookie-based sessions |

### Recommendations

1. **CORS**: Verify API routes explicitly set CORS headers with allowlist (not `*`)
2. **Rate limiting**: Add request throttling for API routes (IP-based or session-based)
3. **CSRF**: Ensure cookies use `SameSite=Strict` or `SameSite=Lax` appropriately

---

## 9. Environment Variables & Secrets

### Current State

| Item | Status | Notes |
|------|--------|-------|
| `.env.example` | ‚úÖ Present | `apps/web/cloudflare.env.example` |
| `.env*` in `.gitignore` | ‚úÖ Present | `.env`, `.env.local`, `.env.production`, `.env.development` |
| `.dev.vars` in `.gitignore` | ‚ö†Ô∏è Not needed | Only for standalone Workers (not used here) |
| Environment variable validation | ‚úÖ Present | Zod schemas in `src/env.client.ts` and `src/env.server.ts` |

### Hardening Required

1. ‚úÖ Environment variables are validated with Zod
2. ‚úÖ Client vs server vars are separated (`NEXT_PUBLIC_*` vs server-only)
3. ‚ö†Ô∏è **Create comprehensive env matrix documentation** (see `docs/deploy/env-matrix.md`)
4. ‚ö†Ô∏è **Document where each variable is set** (Pages Dashboard vs code)

---

## 10. Workers Runtime Compatibility

### Current Configuration (`wrangler.toml`)

```toml
name = "avocat-ai-web"
compatibility_date = "2024-12-01"  # ‚úÖ Current (Dec 2024)
compatibility_flags = ["nodejs_compat"]  # ‚úÖ Required for Next.js
pages_build_output_dir = "apps/web/.vercel/output/static"
```

| Requirement | Status | Notes |
|-------------|--------|-------|
| `name` | ‚úÖ Present | `avocat-ai-web` |
| `compatibility_date` | ‚úÖ Present | `2024-12-01` (recent) |
| `nodejs_compat` | ‚úÖ Present | Required for `process.env` and Node APIs |
| Environment sections | ‚ùå Not needed | Only if using multiple environments in Wrangler |

> [!NOTE]
> This repo uses **Pages Functions** (via next-on-pages), not standalone Workers. The `wrangler.toml` configuration is minimal and correct.

---

## 11. Next.js on Cloudflare

### Current Setup

| Component | Status | Notes |
|-----------|--------|-------|
| Framework | Next.js 14.2.5 | App Router |
| Adapter | `@cloudflare/next-on-pages` | ‚úÖ Version 1.13.0 |
| Runtime | Edge runtime | ‚úÖ All routes use `runtime = 'edge'` |
| `nodejs_compat` | ‚úÖ Enabled | Required for Next.js SSR |
| Compatibility date | ‚úÖ `2024-12-01` | Modern date |

### Verification

- ‚úÖ `@cloudflare/next-on-pages` is in `devDependencies`
- ‚úÖ `pages:build` script runs `next-on-pages` after `next build`
- ‚úÖ All API routes use `export const runtime = 'edge'`
- ‚úÖ Server Components layout uses `export const runtime = 'edge'`

---

## 12. Performance & Caching

### Asset Caching

| Pattern | Current Status | Recommendation |
|---------|---------------|----------------|
| Hashed assets (`/_next/static/*`) | ‚úÖ Cached (immutable) | Long cache ‚úÖ |
| `index.html` | ‚ùå Not configured | Short cache or no-cache |
| Service worker (`/sw.js`) | ‚ùå Not configured | No-cache or short cache |
| Static files (`/icons/*`, `/manifest.json`) | ‚ùå Not configured | Medium cache |

### Bundle Optimization

- ‚úÖ Code splitting: Next.js handles this automatically
- ‚úÖ Lazy loading: Verify heavy routes are lazy-loaded
- ‚ö†Ô∏è Bundle size: Monitor client bundle size

---

## 13. Observability & Debugging

### Current Implementation

| Component | Status | Notes |
|-----------|--------|-------|
| Error reporting | ‚ö†Ô∏è Needs verification | Check if Sentry or equivalent is configured |
| Structured logs | ‚ö†Ô∏è Needs verification | Verify logging in API routes |
| Health checks | ‚úÖ Present | `/healthz` endpoint in API (not in web app) |
| Request IDs | ‚ö†Ô∏è Needs verification | Check trace ID propagation |

### Health Checks

**API Health Check**: `/healthz` exists in `apps/api` (Fastify server)

**Web App Health Check**: ‚ùå **NOT PRESENT** - Consider adding `/healthz` route for monitoring.

### Recommendations

1. Add error reporting (Sentry or equivalent) for frontend + API routes
2. Add structured logging with request IDs
3. Add `/healthz` endpoint to web app for monitoring
4. Add synthetic checks for production URL after deploy

---

## 14. CI/CD Discipline

### Current State

| Item | Status | Notes |
|------|--------|-------|
| GitHub Actions workflows | ‚ùå **NOT FOUND** | No `.github/workflows/*.yml` files |
| PR checks | ‚ö†Ô∏è Unknown | Verify if configured in GitHub |
| Preview deployments | ‚ö†Ô∏è Unknown | Cloudflare Pages may auto-create previews |
| Deployment gates | ‚ùå **NOT IMPLEMENTED** | No automated QA ‚Üí promote flow |
| Rollback plan | ‚ö†Ô∏è Manual | Use Cloudflare Pages dashboard to rollback |

### Required Workflow

1. **PR Checks** (should run on every PR):
   - Install dependencies
   - Lint
   - Typecheck
   - Test
   - Build (verify build succeeds)

2. **Preview Deployments**:
   - Cloudflare Pages auto-creates preview deployments for PRs
   - Should run smoke tests on preview
   - Manual QA before merge

3. **Production Deploy**:
   - Triggered on merge to `main` (or production branch)
   - Run full test suite
   - Deploy to production
   - Run smoke tests

4. **Rollback**:
   - Use Cloudflare Pages dashboard to rollback to previous deployment
   - Document rollback procedure

---

## 15. Pre-Launch Smoke Test Checklist

### Required Tests

- [ ] Fresh load + hard refresh (bust cache)
- [ ] SPA deep links (open `/fr/workspace` directly)
- [ ] Locale routing (test `/fr/*` and `/en/*`)
- [ ] Auth flow (sign in ‚Üí callback ‚Üí logged in state)
- [ ] Core CRUD actions (if applicable)
- [ ] API routes functionality (`/api/session`, `/api/admin/*`)
- [ ] PWA basics:
  - [ ] Manifest loads (`/manifest.json`)
  - [ ] Service worker registers (`/sw.js`)
  - [ ] Offline behavior (if applicable)
- [ ] Security sanity:
  - [ ] Headers present (check response headers)
  - [ ] No secrets in client bundle (inspect source)
  - [ ] CORS behaves correctly (if API calls cross-origin)

---

## 16. Deployment Checklist

### Pre-Deployment (Must Complete)

#### Repo & Build
- [x] Lockfile committed (`pnpm-lock.yaml`)
- [x] Build scripts defined (`lint`, `typecheck`, `test`, `build`, `pages:build`)
- [x] Node version pinned (`.nvmrc`)
- [x] Package manager pinned (`packageManager` field)

#### Cloudflare Configuration
- [x] `wrangler.toml` exists with correct settings
- [x] `compatibility_date` is current (`2024-12-01`)
- [x] `nodejs_compat` flag enabled
- [ ] **Production branch set explicitly in Pages dashboard**
- [ ] **Build command verified in Pages dashboard**
- [ ] **Output directory verified in Pages dashboard**

#### Routing & Headers
- [ ] **Add `_redirects` file for SPA routing**
- [x] `_headers` file exists (but needs enhancement)
- [ ] **Enhance `_headers` with CSP and caching rules**
- [ ] Optional: Add `404.html` if custom 404 needed

#### Environment Variables
- [ ] **All required env vars set in Pages dashboard**:
  - [ ] `NEXT_PUBLIC_API_BASE_URL`
  - [ ] `NEXT_PUBLIC_SUPABASE_URL`
  - [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - [ ] `SUPABASE_URL` (server-only)
  - [ ] `SUPABASE_SERVICE_ROLE_KEY` (server-only, secret)
- [ ] **Create `docs/deploy/env-matrix.md` with complete variable matrix**

#### Security
- [ ] **Enhance `_headers` with CSP**
- [ ] **Add caching headers for `index.html` and service worker**
- [ ] Verify API routes set appropriate CORS headers
- [ ] Consider rate limiting for API routes

#### Observability
- [ ] Configure error reporting (Sentry or equivalent)
- [ ] Add `/healthz` endpoint to web app (optional)
- [ ] Document rollback procedure

#### CI/CD
- [ ] **Create GitHub Actions workflow for PR checks** (lint, typecheck, test, build)
- [ ] Document preview deployment strategy
- [ ] Document rollback procedure

### Post-Deployment Verification

- [ ] Build completes without errors
- [ ] SSR pages render correctly (no static errors)
- [ ] API routes function correctly
- [ ] Service worker registers
- [ ] Locale routing works (`/fr/*`, `/en/*`)
- [ ] Deep links work (direct navigation to nested routes)
- [ ] Security headers present in responses
- [ ] No secrets in client bundle
- [ ] Health checks pass (if implemented)

---

## 17. Risk Assessment

| Risk | Severity | Mitigation | Status |
|------|----------|------------|--------|
| Missing `_redirects` causes 404 on refresh | üî¥ Critical | Add `_redirects` file | ‚ùå Not implemented |
| Missing CSP in `_headers` | üî¥ Critical | Add CSP to `_headers` | ‚ùå Not implemented |
| Stale `index.html` due to long cache | üü° Medium | Add short cache header for `index.html` | ‚ùå Not implemented |
| Missing environment variables | üî¥ Critical | Document and verify all vars in dashboard | ‚ö†Ô∏è Needs verification |
| No rate limiting on API routes | üü° Medium | Add rate limiting middleware | ‚ùå Not implemented |
| No error reporting | üü° Medium | Configure Sentry or equivalent | ‚ùå Not implemented |
| No CI/CD checks | üü° Medium | Add GitHub Actions workflow | ‚ùå Not implemented |
| `sharp` native module incompatibility | üü¢ Low | Only used in build, not runtime | ‚úÖ Safe |
| Lockfile desync on CI | üü¢ Low | Use `--frozen-lockfile` in CI | ‚ö†Ô∏è Needs verification |

---

## 18. Files to Modify/Create

| File | Action | Purpose |
|------|--------|---------|
| `apps/web/public/_redirects` | **CREATE** | SPA routing fallback |
| `apps/web/public/_headers` | **MODIFY** | Add CSP and caching rules |
| `docs/deploy/env-matrix.md` | **CREATE** | Environment variable documentation |
| `docs/deploy/cloudflare-pages-routing.md` | **CREATE** | Routing documentation |
| `docs/deploy/security-headers.md` | **CREATE** | Security headers documentation |
| `docs/deploy/cicd.md` | **CREATE** | CI/CD documentation |
| `.github/workflows/ci.yml` | **CREATE** | PR checks workflow (optional) |
| `wrangler.toml` | ‚úÖ No change needed | Already correct |

---

## 19. Next Steps (Implementation Order)

1. **Prompt 2**: Implement SPA routing (`_redirects` file)
2. **Prompt 3**: Enhance security headers (`_headers` file)
3. **Prompt 4**: Environment variables hardening (documentation)
4. **Prompt 5**: Skip (no standalone Workers)
5. **Prompt 6**: CI/CD documentation and workflow (optional)

---

## 20. Verification Commands

```bash
# Local build test
cd /Volumes/PRO-G40/Projects/repos/lawai
pnpm install
pnpm --filter @avocat-ai/web run pages:build

# Verify output structure
ls -la apps/web/.vercel/output/static/
# Should contain: _worker.js, _routes.json, static assets, _headers, _redirects

# Local preview (after build)
cd apps/web
pnpm run pages:preview
# Or: wrangler pages dev .vercel/output/static

# Test deep link (in browser)
# Navigate to: http://localhost:8788/fr/workspace
# Should work without 404

# Verify headers (in browser DevTools)
# Check Response Headers for security headers
```

---

## Appendix: Reference Documentation

- [@cloudflare/next-on-pages](https://github.com/cloudflare/next-on-pages)
- [Cloudflare Pages Next.js Guide](https://developers.cloudflare.com/pages/framework-guides/nextjs/)
- [Cloudflare Pages Headers](https://developers.cloudflare.com/pages/platform/headers/)
- [Cloudflare Pages Redirects](https://developers.cloudflare.com/pages/platform/redirects/)
- [Wrangler Configuration](https://developers.cloudflare.com/workers/wrangler/configuration/)
- [Next.js App Router on Cloudflare](https://developers.cloudflare.com/pages/framework-guides/nextjs/ssr/get-started/)
