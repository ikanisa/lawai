# Cloudflare Pages Routing Configuration

This document explains how routing works for the Next.js app on Cloudflare Pages and how to test deep links.

## Overview

The `apps/web` application uses Next.js App Router with:
- Locale-based routing: `/[locale]/*` (e.g., `/fr/workspace`, `/en/workspace`)
- API routes: `/api/*`
- Server Components with edge runtime

When deployed to Cloudflare Pages via `@cloudflare/next-on-pages`, the routing behavior needs special configuration for Single Page Application (SPA) fallback.

## SPA Routing with `_redirects`

### File Location

The `_redirects` file is placed in `apps/web/public/_redirects` and will be copied to the build output directory (`apps/web/.vercel/output/static/`) during the build process.

### Configuration

```text
/*    /index.html   200
```

This rule ensures:
1. **All routes serve `index.html`**: Any request that doesn't match a static file will serve `index.html`
2. **Status 200**: Returns a successful HTTP status (not a redirect)
3. **Preserves static assets**: Files like `/_next/static/*`, `/icons/*`, `/manifest.json`, `/sw.js` are served directly because they exist as physical files

### How It Works

1. User navigates to `/fr/workspace` directly (e.g., via bookmark or refresh)
2. Cloudflare Pages checks if a file exists at that path
3. Since no file exists, the `_redirects` rule matches `/*`
4. Pages serves `index.html` with HTTP 200
5. Next.js router (client-side) takes over and renders the correct page component

### Why This Is Needed

Without `_redirects`, direct navigation to routes like `/fr/workspace` would return a 404 error because Cloudflare Pages doesn't know about Next.js routes—it only sees static files.

## Testing Deep Links

### Local Testing

After building the app, test routing locally using Wrangler:

```bash
# Build the app
cd apps/web
pnpm run pages:build

# Start local preview
pnpm run pages:preview
# Or: wrangler pages dev .vercel/output/static

# In browser, test these URLs:
# 1. Root: http://localhost:8788/
# 2. French workspace: http://localhost:8788/fr/workspace
# 3. English workspace: http://localhost:8788/en/workspace
# 4. Deep nested route: http://localhost:8788/fr/research
# 5. API route: http://localhost:8788/api/session
```

All of these should work without 404 errors.

### Production Testing

1. **Fresh load test**: Open a private/incognito window and navigate directly to a deep link:
   ```
   https://your-app.pages.dev/fr/workspace
   ```
   Should load correctly (not 404).

2. **Hard refresh test**: While on a deep link, press `Ctrl+Shift+R` (or `Cmd+Shift+R` on Mac) to hard refresh. The page should reload correctly.

3. **Bookmark test**: Bookmark a deep link, close the browser, reopen, and click the bookmark. Should load correctly.

### Verification Checklist

- [ ] Root path (`/`) redirects to default locale (e.g., `/fr/workspace`)
- [ ] Direct navigation to `/fr/workspace` works
- [ ] Direct navigation to `/en/workspace` works
- [ ] Nested routes work (e.g., `/fr/research`, `/fr/drafting`)
- [ ] API routes work (e.g., `/api/session`, `/api/admin/session`)
- [ ] Static assets are served directly (not via `index.html`):
  - [ ] `/_next/static/*` files load correctly
  - [ ] `/icons/*` images load correctly
  - [ ] `/manifest.json` loads correctly
  - [ ] `/sw.js` (service worker) loads correctly

## Troubleshooting

### Issue: Still getting 404 on refresh

**Possible causes:**
1. `_redirects` file not copied to build output
   - **Solution**: Ensure the file is in `apps/web/public/` (Next.js copies files from `public/` to the build output)

2. Build output doesn't include `_redirects`
   - **Solution**: Check `apps/web/.vercel/output/static/_redirects` exists after build

3. Cloudflare Pages not reading `_redirects`
   - **Solution**: Verify the build output directory in Cloudflare Pages dashboard matches `apps/web/.vercel/output/static`

### Issue: Static assets are served as HTML

**Cause**: The `_redirects` rule is too broad or static assets aren't being excluded.

**Solution**: The current rule is correct—static assets should be served directly because they exist as files. If this happens, check:
- Build output contains the static files
- File paths match exactly (case-sensitive)

### Issue: API routes return HTML

**Cause**: API routes are being caught by the `_redirects` rule.

**Solution**: This shouldn't happen with `@cloudflare/next-on-pages` because API routes are handled by the `_worker.js` edge function, not static files. If this occurs:
- Check that `pages:build` completed successfully
- Verify `_worker.js` exists in the build output
- Check Cloudflare Pages Functions logs for errors

## Related Files

- `apps/web/public/_redirects`: SPA routing configuration
- `apps/web/.vercel/output/static/_routes.json`: Generated by `next-on-pages`, defines which routes are handled by edge functions
- `apps/web/next.config.mjs`: Next.js configuration (includes headers but not routing for Cloudflare)
- `wrangler.toml`: Cloudflare Pages configuration

## References

- [Cloudflare Pages Redirects Documentation](https://developers.cloudflare.com/pages/platform/redirects/)
- [@cloudflare/next-on-pages Routing](https://github.com/cloudflare/next-on-pages/blob/main/docs/routing.md)

