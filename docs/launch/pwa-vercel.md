# Enabling the PWA on Vercel

Deploying the Avocat-AI Francophone web app with progressive web app (PWA) capabilities requires both an environment toggle and a user-consent flow. Follow the checklist below when promoting a build to Vercel environments.

## 1. Prepare the build artifact
- Ensure `node` 20.x is used (Vercel defaults to the `engines.node` field).
- Run `npm install` (or `pnpm install`) followed by `npm run build --workspace @avocat-ai/web` locally or in CI to confirm the service worker bundle (`public/sw.js`) is generated by `scripts/prepare-sw.mjs` / `scripts/inject-sw.mjs`.
- Commit the generated `public/sw.js` artefact or ensure your CI pipeline runs the same scripts before uploading the build output to Vercel.

## 2. Configure environment variables
- In the Vercel project dashboard, add `NEXT_PUBLIC_ENABLE_PWA=true` to each environment where the service worker should be offered (Preview/Production). Leave the variable unset or `false` for environments where the PWA must stay disabled.
- Redeploy the project so the environment variable is present at build time and exposed to the client bundle.

## 3. Verify user consent gating
- After deployment, sign in to the web app and confirm the UI still defers service-worker registration until a user opts in (e.g., by enabling digest notifications from the release notes prompt).
- Approving the digest opt-in or successfully installing the app will persist consent in `localStorage` (`avocat-ai.pwa.consent`). Only then will `registerPwa` execute and the service worker control future sessions.

## 4. Regression checklist
- Load the site in a browser without service-worker support (e.g., older Safari) to confirm the console shows `pwa_registration_unsupported_browser` and the app continues to function.
- Run `npm run test --workspace @avocat-ai/web` to execute the Vitest suite covering the registration guards before shipping a release.

Following these steps keeps staging environments free from unintended service workers while making the production rollout opt-in for end users.
