# Law.ai Monorepo Analysis & Task Backlog

## Quick Start Task Launchpad

If you're looking for the actionable items straight away, use the launchpad below. Each "Start task" button opens a pre-filled GitHub issue so you can pick up the work without hunting through the analysis.

| Priority | Area | Task | Start |
| --- | --- | --- | --- |
| Blocker | Backend | Remove `@ts-nocheck` from the Fastify bootstrap and restore type safety with accompanying unit coverage.【F:apps/api/src/app.ts†L1-L69】 | [▶️ Start task](../../issues/new?title=Task%3A%20Hardening%20Fastify%20bootstrap&body=Fix%20type%20coverage%20and%20tests%20for%20apps%2Fapi%2Fsrc%2Fapp.ts%20after%20removing%20%60%40ts-nocheck%60.) |
| Blocker | Backend | Modularise workspace/compliance routes out of `server.ts` into dedicated domain modules with Supabase access patterns and tests.【F:apps/api/src/domain/workspace/routes.ts†L1-L33】【F:apps/api/src/server.ts†L725-L900】 | [▶️ Start task](../../issues/new?title=Task%3A%20Modularise%20workspace%20routes&body=Port%20workspace%20and%20compliance%20handlers%20from%20apps%2Fapi%2Fsrc%2Fserver.ts%20into%20domain%20modules%20with%20tests.) |
| Blocker | Front-End | Replace demo identity constants with authenticated session context across helpers and compliance flows.【F:apps/web/src/lib/api.ts†L1-L55】【F:apps/web/src/components/compliance-banner.tsx†L1-L173】【F:apps/api/src/server.ts†L725-L900】 | [▶️ Start task](../../issues/new?title=Task%3A%20Wire%20real%20auth%20context&body=Replace%20DEMO_ORG_ID%20usage%20with%20authenticated%20identity%20across%20API%20helpers%20and%20compliance%20flows.) |
| Blocker | Fullstack | Ship persistent ChatKit session storage and connect the web console to start/resume real user sessions instead of relying on demo IDs.【F:apps/api/src/chatkit.ts†L1-L200】【F:apps/web/src/components/admin/admin-view.tsx†L1-L200】 | [▶️ Start task](../../issues/new?title=Task%3A%20Ship%20real%20ChatKit%20sessions&body=Persist%20ChatKit%20sessions%20in%20Supabase%20and%20swap%20DEMO%20identifiers%20for%20authenticated%20users%20across%20web%20and%20API.) |
| High | Platform | Retire `@ts-nocheck` shims across Avocat PWA data, finance workers, and launch readiness UI; reintroduce typed streaming fixtures and tests.【F:apps/api/src/avocat-pwa.ts†L1-L155】【F:apps/api/src/worker.ts†L1-L120】【F:apps/api/src/avocat-pwa-data.ts†L1-L75】【F:apps/web/src/components/admin/launch-readiness-card.tsx†L1-L160】 | [▶️ Start task](../../issues/new?title=Task%3A%20Type-safe%20PWA%20and%20worker%20modules&body=Remove%20%60%40ts-nocheck%60%20from%20Avocat%20PWA%20and%20finance%20worker%20modules%2C%20restore%20types%20and%20add%20regression%20tests.) |
| High | Backend | Add persistent rate limiting for `/runs`, compliance, and auth routes beyond the current in-memory limiter.【F:apps/api/src/server.ts†L73-L121】【F:apps/api/src/rate-limit.ts†L1-L56】 | [▶️ Start task](../../issues/new?title=Task%3A%20Expand%20rate%20limiting&body=Add%20distributed%20rate%20limits%20for%20runs%2C%20compliance%2C%20and%20auth%20routes%20beyond%20telemetry.) |
| High | Supabase | Replace placeholder Supabase Edge Functions with real crawlers, sync jobs, and digest orchestration plus monitoring.【F:supabase/functions/crawl-authorities/index.ts†L1-L37】【F:supabase/functions/drive-watcher/index.ts†L1-L36】【F:supabase/functions/process-learning/index.ts†L1-L44】【F:supabase/functions/regulator-digest/index.ts†L1-L97】 | [▶️ Start task](../../issues/new?title=Task%3A%20Implement%20Supabase%20edge%20jobs&body=Replace%20placeholder%20Supabase%20Edge%20Functions%20with%20real%20sync%20logic%2C%20tests%2C%20and%20observability.) |
| High | Front-End | Gate PWA/service worker registration behind environment flags and explicit user opt-in prompts.【F:apps/web/src/components/providers.tsx†L1-L38】【F:apps/web/src/lib/pwa.ts†L1-L57】 | [▶️ Start task](../../issues/new?title=Task%3A%20Gate%20PWA%20registration&body=Add%20environment%20and%20user%20opt-in%20controls%20before%20registering%20the%20service%20worker.) |
| High | Accessibility | Harden the command palette with focus traps, screen-reader announcements, and shortcut discovery aids.【F:apps/web/src/components/command-palette.tsx†L95-L199】 | [▶️ Start task](../../issues/new?title=Task%3A%20Enhance%20command%20palette%20a11y&body=Add%20WCAG-compliant%20announcements%2C%20focus%20management%2C%20and%20tests%20to%20the%20command%20palette.) |
| High | Orchestration | Implement Supabase-backed finance orchestrator queues and worker loops instead of in-process stubs.【F:apps/api/src/orchestrator.ts†L1-L200】【F:packages/shared/src/orchestrator.ts†L1-L120】 | [▶️ Start task](../../issues/new?title=Task%3A%20Productionise%20finance%20orchestrator&body=Persist%20orchestrator%20sessions%20and%20commands%20in%20Supabase%20and%20move%20processing%20into%20resilient%20workers.) |
| High | Tooling | Extend the Vercel preflight script to validate finance env vars, run workspace installs, and smoke-test API/Web builds before deployment.【F:scripts/vercel-preflight.mjs†L1-L86】【F:apps/api/src/config.ts†L1-L80】 | [▶️ Start task](../../issues/new?title=Task%3A%20Harden%20Vercel%20preflight&body=Update%20scripts%2Fvercel-preflight.mjs%20to%20cover%20finance%20env%20vars%2C%20pnpm%20workspaces%2C%20and%20API%2Fweb%20smoke%20tests%20pre-deploy.) |
| Medium | Backend | Return a typed Supabase service client instead of casting through `unknown`, and surface health probes for downstream consumers.【F:apps/api/src/supabase-client.ts†L1-L8】【F:packages/supabase/src/client.ts†L1-L24】 | [▶️ Start task](../../issues/new?title=Task%3A%20Type%20Supabase%20service%20client&body=Eliminate%20the%20%60unknown%60%20cast%20in%20apps%2Fapi%2Fsrc%2Fsupabase-client.ts%20by%20returning%20a%20typed%20client%20and%20adding%20health%20checks.) |
| Medium | Compliance | Make compliance acknowledgement persistence idempotent with clearer retry UX.【F:apps/api/src/server.ts†L772-L840】【F:apps/web/src/components/compliance-banner.tsx†L41-L173】 | [▶️ Start task](../../issues/new?title=Task%3A%20Stabilise%20compliance%20acknowledgements&body=Add%20idempotency%20and%20better%20error%20states%20for%20compliance%20ack%20flows.) |
| Medium | Ops | Refresh launch runbooks to cover new auth prerequisites and PWA gating so Vercel deployments stay compliant.【F:README.md†L55-L158】 | [▶️ Start task](../../issues/new?title=Task%3A%20Refresh%20launch%20runbooks&body=Document%20auth%20and%20PWA%20requirements%20in%20README%20and%20related%20runbooks.) |

## Architecture Snapshot
- **Workspaces & services:** The repository is organised as a PNPM workspace hosting Fastify APIs, Next.js operator consoles, Supabase edge functions, operational CLIs, and shared TypeScript packages.【F:README.md†L1-L125】
- **Operational tooling:** Runbooks cover provisioning, compliance checks, red-team drills, transparency reporting, and other workflows that depend on the ops CLIs and Supabase resources.【F:README.md†L55-L158】
- **Data plane:** Supabase service clients are constructed in `apps/api` via a thin wrapper around the shared package; the wrapper currently casts through `unknown`, so type drift is possible when the shared client evolves.【F:apps/api/src/supabase-client.ts†L1-L8】【F:packages/supabase/src/client.ts†L1-L24】

## Deep-Dive Findings
### Fastify API & Domain Modules
- The Fastify bootstrap still disables type-checking via `// @ts-nocheck`, leaving the core app factory outside TypeScript safety despite orchestrating sensitive context wiring and route registration.【F:apps/api/src/app.ts†L1-L69】
- Workspace domain routing remains a thin placeholder that simply echoes agent run IDs; the authoritative business logic, access control, and telemetry all live inside the legacy `server.ts` monolith.【F:apps/api/src/domain/workspace/routes.ts†L1-L33】【F:apps/api/src/server.ts†L725-L900】
- Only the telemetry endpoint uses the in-memory rate limiter; compliance, run execution, and other public routes are exposed without distributed throttling or per-route safeguards, leaving DoS exposure for multi-tenant deployments.【F:apps/api/src/server.ts†L73-L121】【F:apps/api/src/rate-limit.ts†L1-L56】
- Supabase service instantiation casts through `unknown`, masking schema drift and blocking health instrumentation for downstream workers or edge functions.【F:apps/api/src/supabase-client.ts†L1-L8】

### Chat Orchestration & Sessions
- ChatKit integration exists server-side but is gated behind environment flags with no persisted Supabase session table usage or web client wiring, so every session still assumes demo identities.【F:apps/api/src/chatkit.ts†L1-L200】【F:apps/web/src/components/admin/admin-view.tsx†L1-L200】
- Finance orchestrator instructions and types live server-side/shared, yet there is no Supabase-backed job loop or worker binding to execute the director/safety flows in production environments.【F:apps/api/src/orchestrator.ts†L1-L200】【F:packages/shared/src/orchestrator.ts†L1-L120】

### Finance Workers & PWA Surfaces
- The Avocat PWA mock routes, data fixtures, finance worker orchestration, and launch readiness UI all rely on `@ts-nocheck`, preventing type feedback on streaming payloads and orchestrator state machines.【F:apps/api/src/avocat-pwa.ts†L1-L155】【F:apps/api/src/avocat-pwa-data.ts†L1-L75】【F:apps/api/src/worker.ts†L1-L120】【F:apps/web/src/components/admin/launch-readiness-card.tsx†L1-L160】
- Finance job processing trusts the shared Zod schemas at runtime but lacks integration coverage to ensure Supabase updates remain in sync with worker state transitions.【F:apps/api/src/worker.ts†L59-L118】

### Front-End Operator Console
- API helpers and compliance UI components hard-code `DEMO_ORG_ID`/`DEMO_USER_ID`, so every browser session impersonates the same tenant until real authentication wiring ships.【F:apps/web/src/lib/api.ts†L1-L55】【F:apps/web/src/components/admin/admin-view.tsx†L1-L194】【F:apps/web/src/components/compliance-banner.tsx†L1-L173】
- `AppProviders` registers the PWA service worker on mount for every environment, while the Workbox helper immediately triggers registration and notification prompts without respecting environment flags or user intent.【F:apps/web/src/components/providers.tsx†L1-L38】【F:apps/web/src/lib/pwa.ts†L1-L57】
- The command palette dialog wires ARIA roles, yet accessibility gaps remain around announcing shortcut help and result updates for assistive tech users—there is no visible instructions link nor focus trapping for closing contexts, and keyboard hints rely on visual-only elements.【F:apps/web/src/components/command-palette.tsx†L95-L199】
- Launch readiness dashboards keep `@ts-nocheck`, so regressions in ops telemetry structures would only surface in production builds.【F:apps/web/src/components/admin/launch-readiness-card.tsx†L1-L160】

### Compliance & Data Integrity
- Compliance acknowledgement writes are batched via a Supabase RPC, but the calling flow lacks idempotency keys or retry classification; transient failures currently bubble as generic 500s, forcing operators to re-click without clarity on persistence state.【F:apps/api/src/server.ts†L772-L840】
- Front-end compliance banner assumes acknowledgements exist; empty states and offline handling are basic toasts, so real tenants lack dedicated guidance when Supabase returns no history or the user is offline.【F:apps/web/src/components/compliance-banner.tsx†L41-L173】

### Supabase Edge Jobs & Integrations
- Scheduled Supabase Edge Functions for crawling authorities, monitoring drives, processing learning runs, and dispatching regulator digests only log payloads; none perform authenticated calls, retries, or alerting, so ingestion pipelines are effectively no-ops.【F:supabase/functions/crawl-authorities/index.ts†L1-L37】【F:supabase/functions/drive-watcher/index.ts†L1-L36】【F:supabase/functions/process-learning/index.ts†L1-L44】【F:supabase/functions/regulator-digest/index.ts†L1-L97】
- Regulator digests post to the API with demo org/user identifiers and swallow downstream errors into a generic 502, so failures are invisible to operators and violate compliance audit requirements.【F:supabase/functions/regulator-digest/index.ts†L17-L97】

### Ops & Deployment
- Runbooks expect secrets, Supabase buckets, vector stores, and ops CLIs to be in sync before go-live, yet there is no automated verification tying new authentication/PWA work to these instructions, risking configuration drift during Vercel deployments.【F:README.md†L55-L158】
- Environment schema defaults still allow placeholder Supabase URLs/keys in non-production setups, increasing the chance of forgetting to configure Vercel environment secrets before release windows.【F:apps/api/src/config.ts†L8-L68】
- The Vercel preflight script only checks a narrow set of environment variables and relies on `npm ci`, so finance workers, pnpm workspace installs, and smoke tests can be skipped before pushing to Vercel.【F:scripts/vercel-preflight.mjs†L1-L86】
- Production readiness reports call out outstanding automation gaps for transparency digests, secret rotation, and connector validation, but those checks are not yet codified into deployment tooling.【F:ops/reports/PRODUCTION_READINESS_AUDIT.md†L1-L63】

## Prioritised Task List
| Priority | Area | Description | Start |
| --- | --- | --- | --- |
| Blocker | Backend | Remove `@ts-nocheck` from the Fastify bootstrap, fix resulting type errors, and ensure the app context wiring is covered by unit tests.【F:apps/api/src/app.ts†L1-L69】 | [▶️ Start task](../../issues/new?title=Task%3A%20Hardening%20Fastify%20bootstrap&body=Fix%20type%20coverage%20and%20tests%20for%20apps%2Fapi%2Fsrc%2Fapp.ts%20after%20removing%20%60%40ts-nocheck%60.) |
| Blocker | Backend | Migrate workspace/compliance routes out of `server.ts` into domain modules with full Supabase access patterns, telemetry, and contract tests.【F:apps/api/src/domain/workspace/routes.ts†L1-L33】【F:apps/api/src/server.ts†L725-L900】 | [▶️ Start task](../../issues/new?title=Task%3A%20Modularise%20workspace%20routes&body=Port%20workspace%20and%20compliance%20handlers%20from%20apps%2Fapi%2Fsrc%2Fserver.ts%20into%20domain%20modules%20with%20tests.) |
| Blocker | Front-End | Replace demo identity constants with authenticated session context across API helpers and compliance UI; ensure headers propagate real org/user IDs end to end.【F:apps/web/src/lib/api.ts†L1-L55】【F:apps/web/src/components/admin/admin-view.tsx†L1-L194】【F:apps/api/src/server.ts†L725-L900】 | [▶️ Start task](../../issues/new?title=Task%3A%20Wire%20real%20auth%20context&body=Replace%20DEMO_ORG_ID%20usage%20with%20authenticated%20identity%20across%20API%20helpers%20and%20compliance%20flows.) |
| Blocker | Fullstack | Persist ChatKit sessions in Supabase and integrate the web console so operators join real sessions with issued secrets instead of demo fallbacks.【F:apps/api/src/chatkit.ts†L1-L200】【F:apps/web/src/components/admin/admin-view.tsx†L1-L200】 | [▶️ Start task](../../issues/new?title=Task%3A%20Ship%20real%20ChatKit%20sessions&body=Persist%20ChatKit%20sessions%20in%20Supabase%20and%20swap%20DEMO%20identifiers%20for%20authenticated%20users%20across%20web%20and%20API.) |
| High | Platform | Retire `@ts-nocheck` across Avocat PWA, finance worker orchestration, and launch readiness dashboards; add typed fixtures and regression tests before enabling new finance agents.【F:apps/api/src/avocat-pwa.ts†L1-L155】【F:apps/api/src/worker.ts†L1-L120】【F:apps/web/src/components/admin/launch-readiness-card.tsx†L1-L160】 | [▶️ Start task](../../issues/new?title=Task%3A%20Type-safe%20PWA%20and%20worker%20modules&body=Remove%20%60%40ts-nocheck%60%20from%20Avocat%20PWA%20and%20finance%20worker%20modules%2C%20restore%20types%20and%20add%20regression%20tests.) |
| High | Backend | Introduce persistent (Redis/Supabase) rate limiting and per-route quotas for `/runs`, compliance endpoints, and other sensitive routes, replacing the single in-memory limiter.【F:apps/api/src/server.ts†L73-L121】【F:apps/api/src/rate-limit.ts†L1-L56】 | [▶️ Start task](../../issues/new?title=Task%3A%20Expand%20rate%20limiting&body=Add%20distributed%20rate%20limits%20for%20runs%2C%20compliance%2C%20and%20auth%20routes%20beyond%20telemetry.) |
| High | Supabase | Implement real ingestion/digest pipelines inside the scheduled Supabase Edge Functions, add retries/alerts, and remove demo identifiers before production scheduling.【F:supabase/functions/crawl-authorities/index.ts†L1-L37】【F:supabase/functions/drive-watcher/index.ts†L1-L36】【F:supabase/functions/process-learning/index.ts†L1-L44】【F:supabase/functions/regulator-digest/index.ts†L1-L97】 | [▶️ Start task](../../issues/new?title=Task%3A%20Implement%20Supabase%20edge%20jobs&body=Replace%20placeholder%20Supabase%20Edge%20Functions%20with%20real%20sync%20logic%2C%20tests%2C%20and%20observability.) |
| High | Front-End | Gate service worker registration and digest notifications behind environment flags and user opt-in prompts aligned with deployment stages.【F:apps/web/src/components/providers.tsx†L1-L38】【F:apps/web/src/lib/pwa.ts†L1-L57】 | [▶️ Start task](../../issues/new?title=Task%3A%20Gate%20PWA%20registration&body=Add%20environment%20and%20user%20opt-in%20controls%20before%20registering%20the%20service%20worker.) |
| High | Accessibility | Augment the command palette with focus-trap tests, screen-reader tutorials, and explicit shortcut toggles exposed outside the dialog for WCAG compliance.【F:apps/web/src/components/command-palette.tsx†L95-L199】 | [▶️ Start task](../../issues/new?title=Task%3A%20Enhance%20command%20palette%20a11y&body=Add%20WCAG-compliant%20announcements%2C%20focus%20management%2C%20and%20tests%20to%20the%20command%20palette.) |
| High | Orchestration | Productionise finance orchestrator queues/workers so director and safety agents execute reliably with retries and audits in Supabase.【F:apps/api/src/orchestrator.ts†L1-L200】【F:packages/shared/src/orchestrator.ts†L1-L120】 | [▶️ Start task](../../issues/new?title=Task%3A%20Productionise%20finance%20orchestrator&body=Persist%20orchestrator%20sessions%20and%20commands%20in%20Supabase%20and%20move%20processing%20into%20resilient%20workers.) |
| High | Tooling | Harden deployment preflight by checking finance env vars, installing PNPM workspaces, and running API/Web smoke tests before Vercel deploys.【F:scripts/vercel-preflight.mjs†L1-L86】【F:apps/api/src/config.ts†L1-L80】 | [▶️ Start task](../../issues/new?title=Task%3A%20Harden%20Vercel%20preflight&body=Update%20scripts%2Fvercel-preflight.mjs%20to%20cover%20finance%20env%20vars%2C%20pnpm%20workspaces%2C%20and%20API%2Fweb%20smoke%20tests%20pre-deploy.) |
| Medium | Backend | Tighten compliance acknowledgement persistence with idempotency tokens, retry classification, and Supabase telemetry so operators can trust the banner state.【F:apps/api/src/server.ts†L772-L840】【F:apps/web/src/components/compliance-banner.tsx†L41-L173】 | [▶️ Start task](../../issues/new?title=Task%3A%20Stabilise%20compliance%20acknowledgements&body=Add%20idempotency%20and%20better%20error%20states%20for%20compliance%20ack%20flows.) |
| Medium | Backend | Return a typed Supabase service client instead of casting through `unknown`, and expose readiness/health probes for long-running workers.【F:apps/api/src/supabase-client.ts†L1-L8】【F:packages/supabase/src/client.ts†L1-L24】 | [▶️ Start task](../../issues/new?title=Task%3A%20Type%20Supabase%20service%20client&body=Eliminate%20the%20%60unknown%60%20cast%20in%20apps%2Fapi%2Fsrc%2Fsupabase-client.ts%20by%20returning%20a%20typed%20client%20and%20adding%20health%20checks.) |
| Medium | Ops | Update runbooks to cover the new auth/session prerequisites, Supabase edge jobs, and PWA gating so Vercel deployments remain compliant with production checklists.【F:README.md†L55-L158】【F:supabase/functions/regulator-digest/index.ts†L17-L97】 | [▶️ Start task](../../issues/new?title=Task%3A%20Refresh%20launch%20runbooks&body=Document%20auth%20and%20PWA%20requirements%20plus%20edge%20job%20operability%20in%20README%20and%20related%20runbooks.) |
| Medium | Governance | Automate transparency digest generation and connector validation called out in production readiness reports so deploys satisfy audit gates.【F:ops/reports/PRODUCTION_READINESS_AUDIT.md†L1-L63】 | [▶️ Start task](../../issues/new?title=Task%3A%20Automate%20readiness%20audits&body=Turn%20production%20readiness%20report%20actions%20into%20scripts%20that%20run%20before%20merging%20to%20main.) |
